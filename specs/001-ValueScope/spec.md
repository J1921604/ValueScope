# 機能仕様書: ValueScope企業価値分析ダッシュボード

**Feature Branch**: `001-ValueScope`  
**Created**: 2025-12-08  
**Status**: 実装済み・品質向上フェーズ  
**バージョン**: 1.0.0  
**GitHubリポジトリ**: https://github.com/J1921604/ValueScope

## ユーザーシナリオとテスト *(必須)*

### User Story 1 - 企業価値指標の即時把握 (Priority: P1)

投資家が東京電力HD・中部電力・JERAの企業価値指標（EV、EV/EBITDA、PER、PBR、時価総額、純有利子負債）を一覧で確認し、投資判断に活用する。

**Why this priority**: 投資家の最優先ニーズは「企業価値を瞬時に比較すること」。この機能がなければダッシュボードの価値がゼロになる。

**Independent Test**: ブラウザで https://j1921604.github.io/ValueScope/ を開き、企業価値指標テーブルが表示され、3社の数値が正しく表示されることを確認できる。

**Acceptance Scenarios**:

1. **Given** ユーザーがダッシュボードURLにアクセス、**When** ページが読み込まれる、**Then** 企業価値指標テーブルが2.5秒以内に表示される（LCP < 2.5秒）
2. **Given** 企業価値指標テーブルが表示されている、**When** ユーザーが各企業の行を確認する、**Then** EV、EV/EBITDA、PER、PBR、時価総額、純有利子負債が正確に表示される
3. **Given** 最新年度が選択されている、**When** 年度切り替えボタンを押す、**Then** 過去10年分のデータに切り替わる

---

### User Story 2 - KPIスコアカードによる財務健全性評価 (Priority: P1)

投資家が電力業界特化KPI（ROIC、WACC、EBITDAマージン、FCFマージン）の信号機評価（緑/黄/赤）を確認し、財務健全性を瞬時に判断する。

**Why this priority**: 企業価値指標と同等に重要な機能。電力業界特化の評価により、汎用的な財務指標では見逃す問題を検出できる。

**Independent Test**: ダッシュボードでKPIスコアカードが表示され、各KPIが緑/黄/赤で評価されていることを確認できる。

**Acceptance Scenarios**:

1. **Given** KPIスコアカードが表示されている、**When** ユーザーが各企業のKPIを確認する、**Then** ROIC、WACC、EBITDAマージン、FCFマージンが信号機色（緑/黄/赤）で評価されている
2. **Given** ROIC実績値が5%以上、**When** スコアカードが描画される、**Then** ROICゲージが緑色で表示される
3. **Given** WACC実績値が4%未満、**When** スコアカードが描画される、**Then** WACCゲージが緑色で表示される（逆転判定）

---

### User Story 3 - 推移グラフによる時系列分析 (Priority: P2)

投資家がKPI指標の過去10年分の推移を視覚的に確認し、トレンド分析を行う。

**Why this priority**: 単年度データだけでは判断できないトレンドを把握するために重要。ただし、P1機能が動作していれば最低限の価値は提供できる。

**Independent Test**: ダッシュボードで推移グラフが表示され、過去10年分のデータが折れ線グラフで可視化されていることを確認できる。

**Acceptance Scenarios**:

1. **Given** 推移グラフが表示されている、**When** ユーザーがグラフにマウスオーバーする、**Then** 各年度の詳細数値がツールチップで表示される
2. **Given** 推移グラフが表示されている、**When** ユーザーが年度範囲を変更する、**Then** 200ms以内にグラフが再描画される（チャート再描画 < 200ms）

---

### User Story 4 - 従業員情報の比較と推移分析 (Priority: P3)

投資家が平均年間給与、平均勤続年数、平均年齢、従業員数を3社間で比較し、従業員の状況を把握する。

**Why this priority**: 企業価値やKPIと比較すると優先度は低いが、長期的な企業評価には重要な情報。

**Independent Test**: 従業員情報タブを開き、比較テーブルと推移グラフが表示されることを確認できる。

**Acceptance Scenarios**:

1. **Given** ユーザーが従業員情報タブを開く、**When** タブが表示される、**Then** 3社の従業員情報比較テーブルが表示される
2. **Given** 従業員情報比較テーブルが表示されている、**When** ユーザーが推移グラフを確認する、**Then** 過去10年分の従業員数推移が折れ線グラフで表示される

---

### User Story 5 - 財務諸表の詳細確認 (Priority: P3)

投資家が損益計算書（PL）、貸借対照表（BS）、キャッシュフロー計算書（CF）の詳細項目を確認し、深掘り分析を行う。

**Why this priority**: 詳細な財務分析には必要だが、企業価値指標とKPIスコアカードがあれば基本的な投資判断は可能。

**Independent Test**: 財務諸表タブを開き、PL/BS/CFの全項目が日本語ラベルで表示されることを確認できる。

**Acceptance Scenarios**:

1. **Given** ユーザーが財務諸表タブを開く、**When** PLタブを選択する、**Then** 売上高、営業利益、当期純利益などの項目が日本語で表示される
2. **Given** 財務諸表タブが表示されている、**When** ユーザーがBSタブを選択する、**Then** 総資産、自己資本、有利子負債などの項目が日本語で表示される

---

### エッジケース

- **データ欠損時の処理**: XBRL解析で発行済株式数が取得できない場合、時価総額およびそれに依存する指標（EV、PER、PBR、EV/EBITDA）は`null`として表示する（ゼロ埋めや補完値を使用しない）
- **ゼロ除算対策**: 分母が0の場合、計算結果を`null`として表示し、エラーを発生させない
- **非上場企業の扱い**: JERA（非上場）は株価データが存在しないため、時価総額関連指標を全て`null`として表示する
- **EDINET API障害時**: 毎年6/20-7/1の期間外はEDINET APIを呼び出さず、既存データを使用する
- **株価データ取得失敗時**: Stooq API障害時は既存の株価データを使用し、エラーログのみを記録する

## 機能要件 *(必須)*

### 機能要件

- **FR-001**: システムは東京電力HD、中部電力、JERAの企業価値指標（EV、EV/EBITDA、PER、PBR、時価総額、純有利子負債）を一覧表示しなければならない
- **FR-002**: システムは電力業界特化KPI（ROIC、WACC、EBITDAマージン、FCFマージン）を信号機方式（緑/黄/赤）で評価しなければならない
- **FR-003**: システムはKPI評価基準として、ROIC（緑≥5%, 黄≥3%, 赤<3%, max 15%）、WACC（緑<4%, 黄<5%, 赤≥5%, max 6%）、EBITDAマージン（緑≥15%, 黄≥10%, 赤<10%, max 30%）、FCFマージン（緑≥5%, 黄≥0%, 赤<0%, max 25%）を適用しなければならない
- **FR-004**: システムはEDINET XBRL実データのみを使用し、推定値・補完値・手動入力データを一切使用してはならない
- **FR-005**: システムはデータ欠損時に`null`として表示し、ゼロ埋めや前年度データの流用を禁止しなければならない
- **FR-006**: システムは分母ゼロのゼロ除算時に計算結果を`null`とし、エラーを発生させてはならない
- **FR-007**: システムは財務3表（PL/BS/CF）の全項目を日本語ラベルで動的に表示しなければならない
- **FR-008**: システムは過去10年分のKPI推移を折れ線グラフで可視化しなければならない
- **FR-009**: システムは従業員情報（平均年間給与、平均勤続年数、平均年齢、従業員数）を3社間で比較表示しなければならない
- **FR-010**: システムはGitHub Pagesで静的サイトとして公開され、HTTPS接続を提供しなければならない
- **FR-011**: システムはEDINET APIキーをGitHub Secretsで管理し、コードベースへの平文保存を厳格に禁止しなければならない
- **FR-012**: システムは毎年6月20日から7月1日の期間のみEDINET APIでデータ取得し、それ以外はスキップしなければならない
- **FR-013**: システムは毎回デプロイ時にStooq API（pandas_datareader経由）で株価データを取得しなければならない
- **FR-014**: システムはPython 3.10.11を標準実行環境とし、`py -3.10`コマンドで実行しなければならない

### 主要エンティティ

- **企業価値データ（valuation.json）**: 時価総額、有利子負債、現金、企業価値（EV）、EBITDA、EV/EBITDA、EPS、PER、BPS、PBR、配当利回りを含む
- **KPIスコアデータ（scorecards.json）**: ROIC、WACC、EBITDAマージン、FCFマージンの実績値とスコア（緑/黄/赤）を含む
- **KPI閾値定義（kpi_targets.json）**: 各KPIの緑・黄・赤閾値、最小値・最大値、単位、説明を定義
- **従業員情報データ（employees.json）**: 平均年間給与、平均勤続年数、平均年齢、従業員数の年次データを含む
- **財務データ（*_financials.json）**: EDINET XBRLから抽出した財務3表の全項目を含む

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: ユーザーは2.5秒以内に企業価値指標テーブルを閲覧できる（LCP < 2.5秒）
- **SC-002**: ユーザーは200ms以内にチャート再描画による年度切り替えを体験できる（チャート再描画 < 200ms）
- **SC-003**: システムは1000人の同時アクセスに耐えられる（GitHub Pages CDN性能）
- **SC-004**: ユニットテストカバレッジ80%以上を維持し、品質を保証する
- **SC-005**: E2E主要フロー100%カバーを達成し、UI操作の全経路を検証する
- **SC-006**: Lighthouseスコア90点以上を維持し、高速なページ読み込みを実現する
- **SC-007**: 初期バンドルサイズgzip後200KB未満を維持し、モバイル環境での高速読み込みを実現する
- **SC-008**: EDINET XBRL実データのみを使用し、推定値・補完値ゼロを達成する
- **SC-009**: データ検証スクリプトでスキーマ違反ゼロを達成し、データ品質を保証する
- **SC-010**: GitHub Actionsで自動ビルド・デプロイを実現し、mainブランチへのpush後4分以内にサイトが更新される
