# 機能仕様書: ValueScope - 企業価値分析ダッシュボード

**Feature Branch**: `main`  
**Created**: 2025-12-15  
**Status**: Production  
**バージョン**: 1.0.0

## ユーザーシナリオとテスト

### ユーザーストーリー 1 - 企業価値指標の可視化 (優先度: P1)

**概要**: 
投資家や経営分析者が、東京電力HD・中部電力・JERAの企業価値指標（EV、EV/EBITDA、PER、PBR）を一目で把握できるダッシュボードを提供する。

**優先度の理由**: 
企業価値分析の核心機能であり、MVPとして最も重要。投資判断の基礎となる指標を正確に表示することで、アプリケーションの価値を提供する。

**独立したテスト**: 
企業価値指標テーブルを表示し、3社（TEPCO/CHUBU/JERA）の時価総額、純有利子負債、企業価値、EV/EBITDA、PER、PBRが正しく計算・表示されることを確認できる。

**受入基準**:

1. **Given** ダッシュボードを開いた時、**When** 企業価値指標テーブルを表示する、**Then** 3社の時価総額、純有利子負債、企業価値、EV/EBITDA、PER、PBRが表示される
2. **Given** 時価総額データが取得できない場合（JERAなど非上場企業）、**When** 指標を計算する、**Then** 時価総額およびそれに依存する指標（EV、PER、PBR、EV/EBITDA）は`null`として表示される
3. **Given** 最新年度のデータを選択した時、**When** 企業価値指標を計算する、**Then** XBRL実データのみを使用し、推定値・補完値は一切含まれない
4. **Given** 分母がゼロの計算が発生した場合、**When** 指標を計算する、**Then** 結果を`null`として返し、エラーを発生させない

---

### ユーザーストーリー 2 - KPIスコアカードの信号機評価 (優先度: P1)

**概要**: 
財務健全性を一目で判断できるよう、ROE（自己資本利益率）、自己資本比率、DSCR（債務返済能力）を信号機方式（緑/黄/赤）で評価する。

**優先度の理由**: 
投資家が財務健全性を迅速に判断するために不可欠な機能。定量的な閾値に基づく自動評価により、意思決定を支援する。

**独立したテスト**: 
KPIスコアカードを表示し、ROE、自己資本比率、DSCRの実績値と信号機評価（緑/黄/赤）が正しく表示されることを確認できる。

**受入基準**:

1. **Given** ダッシュボードを開いた時、**When** KPIスコアカードを表示する、**Then** 3社のROE、自己資本比率、DSCRが実績値と信号機評価（緑/黄/赤）とともに表示される
2. **Given** ROEが10%以上の場合、**When** スコアを評価する、**Then** 緑と表示される
3. **Given** ROEが5%以上10%未満の場合、**When** スコアを評価する、**Then** 黄と表示される
4. **Given** ROEが5%未満の場合、**When** スコアを評価する、**Then** 赤と表示される
5. **Given** 自己資本比率が30%以上の場合、**When** スコアを評価する、**Then** 緑と表示される
6. **Given** 自己資本比率が20%以上30%未満の場合、**When** スコアを評価する、**Then** 黄と表示される
7. **Given** 自己資本比率が20%未満の場合、**When** スコアを評価する、**Then** 赤と表示される
8. **Given** DSCRが1.5倍以上の場合、**When** スコアを評価する、**Then** 緑と表示される
9. **Given** DSCRが1.0倍以上1.5倍未満の場合、**When** スコアを評価する、**Then** 黄と表示される
10. **Given** DSCRが1.0倍未満の場合、**When** スコアを評価する、**Then** 赤と表示される

---

### ユーザーストーリー 3 - 過去10年間のKPI推移グラフ表示 (優先度: P2)

**概要**: 
時系列でKPIの推移を可視化し、企業の財務健全性の変化を分析できるようにする。

**優先度の理由**: 
トレンド分析は企業の成長性や安定性を評価するために重要だが、静的な指標表示（US1、US2）に次ぐ優先度。

**独立したテスト**: 
推移グラフを表示し、過去10年間のROE、自己資本比率、DSCRの推移が折れ線グラフで正しく描画されることを確認できる。

**受入基準**:

1. **Given** 推移グラフタブを選択した時、**When** グラフを描画する、**Then** 過去10年間のROE、自己資本比率、DSCRの推移が折れ線グラフで表示される
2. **Given** 年度フィルタを選択した時、**When** データをフィルタリングする、**Then** 選択した年度のデータのみが表示される
3. **Given** グラフを操作した時、**When** 再描画が発生する、**Then** 200ms以内に再描画が完了する（パフォーマンス要件 PR-004）

---

### ユーザーストーリー 4 - 財務諸表（PL/BS/CF）の3社比較テーブル (優先度: P2)

**概要**: 
損益計算書（PL）、貸借対照表（BS）、キャッシュフロー計算書（CF）を3社横並びで比較できるテーブルを提供する。

**優先度の理由**: 
詳細な財務分析には不可欠だが、企業価値指標やKPIスコアカードに次ぐ優先度。

**独立したテスト**: 
財務諸表タブを選択し、PL/BS/CFの3社比較テーブルが正しく表示され、年度フィルタが動作することを確認できる。

**受入基準**:

1. **Given** 財務諸表タブを選択した時、**When** テーブルを表示する、**Then** PL/BS/CFの3社比較テーブルが表示される
2. **Given** 年度フィルタを選択した時、**When** データをフィルタリングする、**Then** 選択した年度（FY2015～FY2024）のデータが表示される
3. **Given** XBRL_output/からCSVデータを読み込む時、**When** データを解析する、**Then** 全項目が日本語ラベルで表示される

---

### エッジケース

- XBRLデータに発行済株式数が含まれない場合、時価総額および依存指標（EV、PER、PBR、EV/EBITDA）は`null`とする
- 分母がゼロの計算（ROE、自己資本比率、DSCR、EV/EBITDA、PER、PBR）が発生した場合、結果を`null`とする
- 非上場企業（JERA）の株価データが存在しない場合、時価総額を`null`とする
- データ取得APIエラーが発生した場合、既存のキャッシュデータを表示し、エラーメッセージをログに記録する
- GitHub Actionsでのデータ更新が失敗した場合、GitHub Issueを自動起票する

## 要件

### 機能要件

- **FR-001**: システムは東京電力HD、中部電力、JERAの企業価値指標（時価総額、純有利子負債、企業価値、EV/EBITDA、PER、PBR）を計算し、表示しなければならない
- **FR-002**: システムはKPI（ROE、自己資本比率、DSCR）を計算し、信号機方式（緑/黄/赤）で評価しなければならない
- **FR-003**: システムは過去10年間のKPI推移を折れ線グラフで表示しなければならない
- **FR-004**: システムは財務諸表（PL/BS/CF）を3社横並びで比較表示しなければならない
- **FR-005**: システムはEDINET API v2から有価証券報告書（書類種別コード120）のXBRLデータを取得しなければならない
- **FR-006**: システムは訂正報告書（コード130）を除外しなければならない
- **FR-007**: システムはStooq API（pandas_datareader経由）から株価データを取得しなければならない
- **FR-008**: システムはすべての財務指標計算にXBRL実データのみを使用し、推定値・補完値・仮定値を一切含めてはならない
- **FR-009**: システムはデータ欠損時に`null`または`0`を返し、推定による補完を行ってはならない
- **FR-010**: システムは分母がゼロの計算をスキップし、結果を`null`としなければならない
- **FR-011**: システムはJSONスキーマ検証を実施し、不正なデータ構造を検出した場合はデプロイを中止しなければならない
- **FR-012**: システムは年度フィルタボタン（FY2015～FY2024）を提供し、ユーザーが任意の年度を選択できるようにしなければならない
- **FR-013**: システムは会計年度ラベルを決算日の1年繰り下げたFY表記（例: 2025/03/31 → FY2024）で表示しなければならない

### 主要エンティティ

- **ValuationData**: 企業価値指標データ（時価総額、純有利子負債、企業価値、EV/EBITDA、PER、PBR、配当利回り）
- **Scorecard**: KPIスコアカードデータ（ROE、自己資本比率、DSCRの実績値、評価、前期比変動）
- **TimeSeriesDataPoint**: 時系列データポイント（年度、ROE、自己資本比率、DSCR、営業CF）
- **FinancialStatement**: 財務諸表データ（PL/BS/CFの全項目）
- **KPITargets**: KPI閾値定義（ROE、自己資本比率、DSCRの緑/黄閾値）

## 成功基準

### 測定可能な成果

- **SC-001**: ユーザーはダッシュボードにアクセスしてから2.5秒以内に企業価値指標を確認できる（LCP < 2.5秒）
- **SC-002**: ユーザーはダッシュボードにアクセスしてから2.0秒以内に操作可能になる（TTI < 2.0秒）
- **SC-003**: システムは1000人の同時アクセスユーザーに対してパフォーマンス劣化なくサービスを提供できる（GitHub Pages CDN対応）
- **SC-004**: データ更新失敗率は5%未満である（EDINET APIおよび株価API取得の成功率95%以上）
- **SC-005**: ユーザーは初回訪問時に90%以上の確率で企業価値指標とKPIスコアカードを正しく理解できる（UIツールチップ、説明文の明確性）
- **SC-006**: システムはXBRL/CSV解析を60秒以内、企業価値計算を10秒以内、データ検証を5秒以内に完了できる
- **SC-007**: ユニットテストカバレッジは80%以上、E2E主要フローは100%カバーできている
- **SC-008**: Lighthouseスコアは90点以上を維持できている
- **SC-009**: 初期バンドルサイズはgzip圧縮後200KB未満である
- **SC-010**: チャート再描画は200ms以内に完了する
