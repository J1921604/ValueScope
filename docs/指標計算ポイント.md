
## 主要指標計算式

### 1. 企業価値（EV）関連指標

#### 1.1 時価総額（Market Capitalization）
```
時価総額 = 株価 × 発行済株式数
```
- **株価**: 決算日時点の終値（Stooq / pandas_datareaderより取得）
- **発行済株式数**: XBRL `issuedShares` から取得
- **単位**: 百万円（株価[円] × 発行済株式数 / 1,000,000）
- **データソース**: 実データのみ（推定値なし）

#### 1.2 純有利子負債（Net Debt）
```
純有利子負債 = 有利子負債 - 現金及び預金
```
- **有利子負債**: XBRL `interestBearingDebt` から取得
- **現金及び預金**: XBRL `cashAndDeposits` から取得
- **単位**: 百万円
- **データソース**: 実データのみ

#### 1.3 企業価値（Enterprise Value）
```
企業価値（EV） = 時価総額 + 純有利子負債
```
- **計算条件**: 時価総額が存在する場合のみ計算（非上場企業はnull）
- **単位**: 百万円
- **データソース**: 実データのみ

#### 1.4 EV/EBITDA倍率
```
EV/EBITDA倍率 = 企業価値 / EBITDA
```
- **EBITDA**: XBRL `ebitda` から取得（営業利益 + 減価償却費）
- **計算条件**: EBITDA > 0 の場合のみ計算
- **単位**: 倍
- **データソース**: 実データのみ

#### 1.5 PER（株価収益率）
```
PER = 時価総額 / 当期純利益
```
- **当期純利益**: XBRL `netIncome` から取得
- **計算条件**: 当期純利益 > 0 の場合のみ計算
- **単位**: 倍
- **データソース**: 実データのみ

#### 1.6 PBR（株価純資産倍率）
```
PBR = 時価総額 / 自己資本
```
- **自己資本**: XBRL `equity` から取得
- **計算条件**: 自己資本 > 0 の場合のみ計算
- **単位**: 倍
- **データソース**: 実データのみ

---

### 2. KPI指標

#### 2.1 ROE（自己資本利益率）
```
ROE = (当期純利益 / 自己資本) × 100
```
- **当期純利益**: XBRL `netIncome` から取得
- **自己資本**: XBRL `equity` から取得
- **計算条件**: 自己資本 > 0 の場合のみ計算
- **単位**: %（パーセント）
- **データソース**: 実データのみ（推定値なし）

#### 2.2 自己資本比率（Equity Ratio）
```
自己資本比率 = (自己資本 / 総資産) × 100
```
- **自己資本**: XBRL `equity` から取得
- **総資産**: XBRL `totalAssets` から取得
- **計算条件**: 総資産 > 0 の場合のみ計算
- **単位**: %（パーセント）
- **データソース**: 実データのみ

#### 2.3 DSCR（Debt Service Coverage Ratio）
```
DSCR = 営業CF / (1年内返済予定の固定負債 + 支払利息)
```
- **営業CF**: CF `operatingCashFlow` から取得
- **1年内返済予定の固定負債**: BS `currentPortionOfNoncurrentLiabilities` から取得
- **支払利息**: PL `interestExpenses` から取得
- **計算条件**: (1年内返済予定の固定負債 + 支払利息) > 0 の場合のみ計算
- **単位**: 倍
- **データソース**: 実データのみ（推定値なし）

---
上記に間違いが有れば修正しろ

主要な式は概ね正しいですが、**実務上の定義の厳密化**や**XBRL項目の選び方**でいくつか改善余地があります。
下記のポイントを修正・補足すると、指標の一貫性と比較可能性が上がります。

***

## 修正ポイント（要約）

1.  **時価総額**
    *   **発行済株式数**は「自己株式を除く」\*\*期末時点の発行済株式数（株主資本に帰属する普通株）\*\*を使うと精度が上がります。
    *   **株価**は**分割・併合調整済みの終値**（決算日が非営業日の場合は直近営業日）。
    *   単位は百万円（`/ 1,000,000`）でOK。

2.  **純有利子負債（Net Debt）**
    *   現金は\*\*「現金及び現金同等物（cashAndCashEquivalents）」\*\*を使うのが標準。`cashAndDeposits`のみだと定期預金や現金同等物を取りこぼす可能性。
    *   有利子負債は**短期借入金＋長期借入金＋社債＋（IFRSなら）リース負債**まで含めるとより一般的。

3.  **企業価値（EV）**
    *   実務では **EV = 時価総額 + 純有利子負債 + 非支配持分 + 優先株式** が一般的（非支配持分や優先株がある場合）。
    *   データが揃わない場合は、最低限の版として「時価総額 + 純有利子負債」でも可。

4.  **EV/EBITDA**
    *   **EBITDA = EBIT（営業利益） + 減価償却費 + 無形資産償却費（のれん含む場合あり）** が標準。`減価償却費`だけだと\*\*償却費（Amortization）\*\*を漏らします。
    *   期ズレ防止のため、**EVの算定日（期末）と同じ12カ月（LTM）のEBITDA**を推奨。

5.  **PER**
    *   分母は\*\*「親会社株主に帰属する当期純利益（Profit attributable to owners of parent）」\*\*を使うとP/E定義と整合。
    *   マイナス利益の場合は算出しない／「—」とするのは妥当。

6.  **PBR**
    *   分母は\*\*「親会社株主に帰属する自己資本（Equity attributable to owners of parent）」\*\*が標準（非支配持分を含めない）。

7.  **ROE**
    *   分母は\*\*期中平均自己資本（期首・期末平均）\*\*が一般的。期末残高のみだと歪みやすい。
    *   分子は**親会社株主に帰属する当期純利益**。

8.  **自己資本比率**
    *   自己資本は**親会社株主に帰属する自己資本**、総資産は**連結総資産**。期末時点でOK。

9.  **DSCR**
    *   デノミネータ（債務サービス）は**キャッシュベース**が推奨：  
        **利息の支払額（CF計算書のInterest paid）＋元本返済額（借入金返済・社債償還・リース債務返済のCF項目）**。
    *   PLの`interestExpenses`は**発生主義**なので、CF指標のDSCRとはズレやすい。

***

## 修正後の推奨定義（コードブロック）

```text
1. 企業価値（EV）関連指標

1.1 時価総額（Market Capitalization）
時価総額 = 調整終値（決算日または直近営業日） × 発行済株式数（自己株式除く）
単位: 百万円（/ 1,000,000）

1.2 純有利子負債（Net Debt）
純有利子負債 = 有利子負債合計 − 現金及び現金同等物
（有利子負債合計 = 短期借入金 + 長期借入金 + 社債 + 〔IFRS〕リース負債 など）
単位: 百万円

1.3 企業価値（Enterprise Value, EV）
基本形: EV = 時価総額 + 純有利子負債
推奨形: EV = 時価総額 + 純有利子負債 + 非支配持分 + 優先株式
単位: 百万円
条件: 時価総額が取得可能な場合のみ算出（非上場は null）

1.4 EV/EBITDA倍率
EV/EBITDA = EV / EBITDA
EBITDA = EBIT（営業利益） + 減価償却費 + 無形資産償却費（のれん償却を含む場合あり）
条件: EBITDA > 0 の場合のみ算出
単位: 倍

1.5 PER（株価収益率）
PER = 時価総額 / 親会社株主に帰属する当期純利益
条件: 分子・分母が同一期間、かつ 当期純利益 > 0
単位: 倍

1.6 PBR（株価純資産倍率）
PBR = 時価総額 / 親会社株主に帰属する自己資本
条件: 自己資本 > 0
単位: 倍

-----------------------------------------

2. KPI指標

2.1 ROE（自己資本利益率）
ROE = (親会社株主に帰属する当期純利益 / 期中平均自己資本) × 100
（期中平均自己資本 = (期首自己資本 + 期末自己資本) / 2）
条件: 期中平均自己資本 > 0
単位: %

2.2 自己資本比率（Equity Ratio）
自己資本比率 = (親会社株主に帰属する自己資本 / 総資産) × 100
条件: 総資産 > 0
単位: %

2.3 DSCR（Debt Service Coverage Ratio）
DSCR = 営業CF / (利息の支払額 + 元本返済額)
・営業CF: CF計算書の Net cash from operating activities
・利息の支払額: CF計算書の Interest paid（IFRSは営業または財務CFに分類）
・元本返済額: 借入金返済、社債償還、〔IFRS〕リース債務返済のキャッシュアウト
条件: (利息の支払額 + 元本返済額) > 0
単位: 倍
```

***

## XBRL項目の実務的マッピング（例）

※各社の会計基準（IFRS/日本基準）・拡張タクソノミによってラベルが異なるため、**概念ベース**で拾うのが安全です。

*   **株式関連**
    *   発行済株式数（自己株式除く）: `NumberOfIssuedAndOutstandingShares`（自己株式は `TreasuryShares`）
*   **負債関連**
    *   短期借入金: `ShortTermBorrowings`
    *   長期借入金: `LongTermBorrowings`
    *   社債: `BondsPayable`
    *   リース負債（IFRS16）: `LeaseLiabilities`
    *   1年内返済予定部分: `CurrentPortionOfLongTermBorrowingsAndBonds` 等
*   **現金関連**
    *   現金及び現金同等物: `CashAndCashEquivalents`（`cashAndDeposits`は範囲が狭い）
*   **損益・CF関連**
    *   営業利益（EBIT）: `OperatingProfit` / `ProfitBeforeFinanceCostsAndIncomeTaxes`（会社表記に依存）
    *   減価償却費: `Depreciation`
    *   無形資産償却費: `AmortizationOfIntangibleAssets` / `Amortization`
    *   当期純利益（親会社株主に帰属）: `ProfitAttributableToOwnersOfParent`
    *   総資産: `TotalAssets` / `Assets`
    *   営業CF: `NetCashProvidedByUsedInOperatingActivities`
    *   利息の支払額: `InterestPaid`（IFRSは営業/財務どちらにもあり得る）
    *   借入金返済・社債償還・リース返済: `RepaymentsOfBorrowings`, `RedemptionOfBonds`, `RepaymentsOfLeaseLiabilities`
*   **持分**
    *   非支配持分: `NonControllingInterests`
    *   親会社株主に帰属する自己資本: `EquityAttributableToOwnersOfParent`

> もし会社が「EBITDA」を直接ディスクロージャしていない場合は、\*\*EBIT + D\&A（減価償却費＋無形資産償却費）\*\*で算出してください。

***

## 実装チェックリスト

*   [ ] 期ズレ防止：\*\*株価（期末）と財務数値（同期間/LTM）\*\*を合わせる
*   [ ] 単位統一：**すべて百万円**に換算（円→百万円は `/ 1,000,000`）
*   [ ] 分子・分母の属性整合：**親会社株主ベース**で統一（PER/PBR/ROE）
*   [ ] データ欠落時の扱い：**推定値なし**方針に従い `null` を返す
*   [ ] IFRS16対応：**リース負債**を有利子負債へ含める（可能なら）
*   [ ] DSCRは**キャッシュベース**（Interest paid と Principal repayments）

***

## 補足（任意）

*   EVに非支配持分・優先株式を含めると、**EBITDA（企業全体の業績）との整合が高まり**、他社比較での歪みが減ります。
*   PER/PBR/ROEの「親会社株主」ベース統一は、**非支配持分の有無による比較のブレ**を抑えます。
*   DSCRは銀行や業界で定義差があるため、**貴社内の標準定義を明文化**しておくと運用が安定します。

***
